import { Box, Text } from '@roots/bud-support/ink';
import React from '@roots/bud-support/react';
import figures from 'figures';
import { relative } from 'node:path/posix';
import Chunk from '../chunk/chunk.component.js';
import ChunkGroup from '../chunk/chunkgroup.component.js';
import Space from '../display/space.component.js';
import Title from '../display/title.component.js';
import { color, colorFromStats, duration, longestAssetNameLength, VERT, } from '../format.js';
import Messages from '../messages/messages.component.js';
const onlyNotHot = ({ name }) => !name?.includes(`hot-update`);
const onlyStatic = ({ info }) => info.copied;
const Compilation = ({ displayAssets, displayEntrypoints, stats, id, context, mode, compilerCount, }) => {
    const enrich = (asset) => {
        const assetModule = stats?.assets?.find(a => a.name === asset.name);
        return { ...asset, ...assetModule };
    };
    const entrypoints = stats?.entrypoints
        ? Object.values(stats?.entrypoints)
            .filter(Boolean)
            .map(entrypoint => ({
            ...entrypoint,
            assets: entrypoint.assets.map(enrich),
        }))
        : [];
    const longestEntrypointAssetLength = entrypoints.reduce((longest, entry) => Math.max(longestAssetNameLength(entry.assets), longest), 0);
    const staticAssets = (stats?.assets ?? [])
        .filter(onlyNotHot)
        .filter(onlyStatic)
        .filter(Boolean)
        .map(enrich);
    const hiddenStaticAssets = staticAssets.splice(5);
    return (React.createElement(Box, { flexDirection: "column" },
        React.createElement(Box, { flexDirection: "row" },
            React.createElement(Text, { color: colorFromStats(stats) }, stats?.errorsCount > 0 ? figures.cross : figures.circleFilled),
            React.createElement(Text, null, `  `),
            React.createElement(Text, null, stats.name),
            React.createElement(Text, null,
                " ",
                ``),
            stats?.outputPath && (React.createElement(Text, { color: color.blue },
                "./",
                relative(context.basedir, stats.outputPath))),
            React.createElement(Text, null, ` `),
            React.createElement(Text, { dimColor: true },
                "[",
                stats.hash,
                "]")),
        !stats.isChild && (React.createElement(React.Fragment, null,
            React.createElement(Text, { dimColor: true }, VERT),
            React.createElement(Messages, { type: "error", color: color.red, messages: stats.errors, figure: figures.cross }),
            React.createElement(Messages, { type: "warning", color: color.yellow, messages: stats.warnings, figure: figures.warning }),
            React.createElement(Box, { flexDirection: "column" }, entrypoints.some(({ assets }) => assets?.length > 0) ? (React.createElement(Box, { flexDirection: "column" },
                React.createElement(Title, null,
                    React.createElement(Text, { color: colorFromStats(stats), dimColor: displayEntrypoints === false },
                        React.createElement(Text, { underline: true }, "e"),
                        "ntrypoints")),
                displayEntrypoints
                    ? entrypoints
                        .filter(({ assets }) => assets.length > 0)
                        .map((chunk, id) => (React.createElement(Box, { key: id, flexDirection: "column" },
                        React.createElement(ChunkGroup, { indent: [true], ...chunk, minWidth: longestEntrypointAssetLength, final: id === entrypoints.length - 1 }))))
                    : null,
                React.createElement(Space, null,
                    React.createElement(Text, null, " ")))) : null),
            staticAssets?.length > 0 ? (React.createElement(Box, { flexDirection: "column" },
                React.createElement(Title, null,
                    React.createElement(Text, { color: colorFromStats(stats), dimColor: displayAssets === false },
                        React.createElement(Text, { underline: true }, "a"),
                        "ssets")),
                displayAssets ? (React.createElement(React.Fragment, null,
                    React.createElement(Chunk, { assets: staticAssets, indent: [true] }),
                    React.createElement(Space, null,
                        React.createElement(Text, null, " ")),
                    hiddenStaticAssets?.length > 0 && (React.createElement(Space, null,
                        React.createElement(Text, { dimColor: true },
                            ` `,
                            figures.ellipsis,
                            ` `,
                            hiddenStaticAssets.length,
                            ` `,
                            "additional asset(s) not shown"))))) : null)) : null,
            React.createElement(Space, null,
                React.createElement(Text, null, " ")))),
        React.createElement(Title, { final: true },
            React.createElement(Text, { dimColor: true },
                "compiled ",
                stats?.modules?.length,
                " modules in",
                ` `,
                duration(stats?.time)))));
};
export default Compilation;
//# sourceMappingURL=compilation.component.js.map